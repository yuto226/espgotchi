# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際のClaude Code (claude.ai/code) へのガイダンスを提供します。
本プロジェクトでは、STM32形式のハードウェアを対象としているたまごっちエミュレータをESP32形式で実行できる様に作成していくプロジェクトです。

## タスクについて(超重要)
本プロジェクトは以下のタスクの通り進行するものとする。
なお、実装が完了したものには順次チェックをつけていくのでそれを持ってタスクの進捗を考えること

1. ESP32用HAL層実装
[]GPIO/入力処理 
[]SPI通信 
[]時間管理/タイマー 
[]音声出力(PWM/DAC) 
[]バッテリー測定(ADC) 
[]電力管理 

## ビルドシステムと開発コマンド

このプロジェクトはSTM32マイクロコントローラーを対象としたMakefileベースのビルドシステムを使用しています：

```bash
make                    # デフォルトボード(opentama)用のファームウェアをビルド
make flash             # デバイスにファームウェアを書き込み（方法を自動検出）
make clean             # ビルド成果物をクリーン
BOARD=discovery_stm32f0 make  # STM32F072 Discoveryボード用にビルド
```

**必要な依存関係:**
- GNU ARM Embedded Toolchain（`../toolchain/`に配置が想定されている）
- OpenOCD（ST-Link書き込み用）
- dfu-util（DFUブートローダー書き込み用）
- Tamagotchi P1 ROMファイル（`rom0.bin`として配置）

**書き込み方法:**
- OpenTamaボード: dfu-util経由のDFUブートローダー
- Discoveryボード: OpenOCD経由のST-Link

## コードアーキテクチャ

### ハードウェア抽象化レイヤー（HAL）
コードベースは多層抽象化アプローチを使用：
- **TamaLIB**: ハードウェア非依存のTamagotchi P1エミュレーター（gitサブモジュール）
- **HALレイヤー**: `src/mcu/inc/`内のカスタム抽象化、TamaLIBとハードウェア間の橋渡し
- **MCU実装**: `src/mcu/stm32/`内のSTM32固有コード

### ジョブベーススケジューラー
協調的マルチタスキングシステム（`src/job.c/h`）：
- マイクロ秒精度の非プリエンプティブタスクスケジューリング
- 主要ジョブ: CPU エミュレーション、レンダリング、バッテリー監視、自動保存
- 32.768kHz Tamagotchiタイミングのリアルタイム制約

### グラフィックスパイプライン
128x64抽象化によるマルチディスプレイサポート（`src/gfx.c/h`）：
- ディスプレイドライバー: SSD1306 OLED（`src/ssd1306.c/h`）とUC1701X LCD（`src/uc1701x.c/h`）
- Tamagotchi 32x16 LCDマトリックスを8つのステータスアイコンと共にフルディスプレイにスケール

### 設定システム
フラッシュに保存される永続設定（`src/config.c/h`）：
- 画面反転、バックライト、スピーカー、LED、バッテリー監視
- 階層ナビゲーション付きメニューシステム（`src/menu.c/h`）
- 10スロットと自動保存機能付きセーブステート

## ボードサポート

**デフォルトボード**: OpenTama（STM32L072 + UC1701X LCD）
**代替**: STM32F072 Discovery + SSD1306 OLED

ボード設定ファイルは以下を定義：
- ボタン、ディスプレイ、LED、スピーカー用のGPIOピンマッピング
- ディスプレイタイプ選択とパラメーター
- 電源管理設定

## 主要ファイル

- `src/main.c` - アプリケーションエントリーポイントとメインループ
- `src/state.c/h` - Tamagotchi状態管理と保存/読み込み
- `src/rom.c/h` - ROMファイル管理と読み込み
- `src/mcu/stm32/STM32L0/board_opentama.h` - デフォルトボード設定
- `libs/TamaLIB/` - Tamagotchiエミュレーションエンジン（サブモジュール）

## 開発ノート

- リアルタイムエミュレーション要件により全てのタイミングが重要
- ハードウェア抽象化により他のSTM32バリエーションへの移植が可能
- USB MSCモードによりROMとセーブファイルの簡単な転送が可能
- バッテリー動作のため電力効率が重要
- 3ボタンインターフェースには長押し検出を含む慎重な入力処理が必要